# LunaTV AI 功能说明文档

## 📚 目录

- [功能概述](#功能概述)
- [功能特性](#功能特性)
- [管理员配置指南](#管理员配置指南)
- [用户使用指南](#用户使用指南)
- [技术说明](#技术说明)
- [常见问题](#常见问题)

---

## 功能概述

LunaTV 的 AI 功能提供智能影视推荐和上下文感知对话，基于 OpenAI 兼容的 API，并支持可选的联网搜索功能。

### 最新增强

✨ **5 大 AI 增强功能：**

1. **Markdown 渲染** - 专业格式化，支持代码高亮、链接和列表
2. **AI 智能协调器** - 智能意图分析和自动联网搜索
3. **视频上下文** - 针对特定影片的上下文感知对话
4. **智能 UI 集成** - 影片卡片上的智能 AI 按钮
5. **流式响应** - 实时逐字显示 AI 回复

---

## 功能特性

### 1. Markdown 渲染

AI 回复现在支持 GitHub 风格的 Markdown，包括：
- **代码块** 带语法高亮
- **链接** 可点击
- **列表** （有序和无序）
- **加粗/斜体** 文本格式
- **表格** 用于结构化数据

### 2. AI 智能协调器（Smart Orchestrator）

协调器自动分析用户意图，决定是否需要联网搜索最新信息。

**意图类型：**
- `recommendation` - 影视剧推荐
- `query` - 演员/导演信息、新闻
- `detail` - 剧情、评价、评分
- `general` - 其他问题

**自动联网搜索触发条件：**
- 时效性关键词（最新、今年、2024、2025、即将、上映等）
- 演员/导演查询（演员、导演、主演等）
- 新闻请求（新闻、消息、官宣等）

**支持的搜索服务：**
- **Tavily** - 每个 Key 每月 1000 次免费 API 调用

### 3. 视频上下文支持

从视频卡片使用 AI 时，AI 自动知道：
- 影片/剧集标题
- 上映年份
- 类型（电影/电视剧）
- 当前集数（电视剧）
- 豆瓣 ID / TMDB ID

**优势：**
- 无需重复说明片名
- 更准确的回答
- 自然的对话流程
- 针对性的网络搜索

### 4. 智能影片卡片 AI 按钮

**桌面端体验：**
- 鼠标悬停在任意影片卡片上
- 底部中央显示 AI 按钮
- 智能定位：避免遮挡底部标签
- 玻璃态设计配合渐变色

**移动端体验：**
- 长按或右键点击影片卡片
- 从操作菜单中选择"AI问片"
- 全屏 AI 对话框

### 5. 流式响应

逐字实时显示 AI 回复，带来：
- 更好的用户体验
- 即时反馈
- 降低感知延迟

---

## 管理员配置指南

### 基础 AI 设置

进入：**管理面板 → AI推荐配置**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| **启用 AI** | AI 功能总开关 | `false` |
| **API URL** | OpenAI 兼容的 API 端点 | `https://api.openai.com/v1` |
| **API Key** | 你的 API 密钥 | （必填） |
| **模型** | 模型名称（如 gpt-4, gpt-3.5-turbo） | `gpt-3.5-turbo` |
| **温度** | 响应随机性 (0-2) | `0.7` |
| **最大 Token** | 最大响应长度 | `3000` |

### 智能协调器设置（高级）

展开：**智能协调器设置（高级）**

#### 启用智能协调器
切换以启用意图分析和自动联网搜索。

#### 启用联网搜索
需要先启用协调器。启用后，AI 会自动为时效性问题联网搜索。

#### Tavily API Keys（多 Key 支持）

**为什么要多个 Key？**
- 每个 Tavily 账号提供 **每月 1000 次免费 API 调用**
- 配置多个 Key 可以增加配额
- 示例：5 个 Key = 每月 5000 次免费调用

**如何获取 Tavily API Key：**

1. 访问 [https://tavily.com](https://tavily.com)
2. 注册免费账号（无需信用卡）
3. 从控制台获取 API Key
4. 用多个邮箱重复以上步骤获取更多 Key

**配置方法：**
```
每行输入一个 API Key：
tvly-xxxxxxxxxxxxxx
tvly-yyyyyyyyyyyyyy
tvly-zzzzzzzzzzzzzz
```

**Key 轮询机制：**
- 系统自动轮询使用可用的 Key
- 失败的 Key 会被标记并跳过
- 遇到 401/429 错误时自动切换下一个 Key

---

## 用户使用指南

### 使用全局 AI 按钮

**位置：** 右上角（桌面端）或顶部栏（移动端）

**步骤：**
1. 点击 AI 按钮（⭐ Sparkles 图标）
2. 输入你的问题
3. 按回车或点击发送
4. 查看流式响应

**示例问题：**
- "推荐一些高分科幻电影"
- "2025年有什么新上映的电影？"
- "诺兰的电影有哪些？"

### 在影片卡片上使用 AI

**桌面端：**
1. 鼠标悬停在任意影片/剧集卡片上
2. 底部中央出现 AI 按钮
3. 点击打开 AI 对话
4. AI 已经知道你在问哪部影片

**移动端：**
1. 长按或右键点击影片卡片
2. 从菜单选择"AI问片"
3. AI 对话框打开，带有上下文

**示例上下文感知问题：**
- "这部讲什么？" → AI 知道你在问这部特定的影片
- "评分怎么样？"
- "有续集吗？"
- "演员阵容如何？"

### 快捷操作按钮

当从影片卡片打开 AI 对话时，会显示快捷操作按钮：
- 📖 **剧情介绍** - 获取剧情摘要
- 🎬 **推荐高分电影** - 通用推荐
- 🆕 **最新上映** - 最新发布

---

## 技术说明

### 流式实现

**后端（SSE）：**
```typescript
// API 返回 Server-Sent Events 流
Content-Type: text/event-stream
data: {"text": "你好"}
data: {"text": "世界"}
data: [DONE]
```

**前端：**
```typescript
// 客户端实时接收 chunk
sendAIRecommendMessage(messages, context, (chunk) => {
  // 每个 chunk 更新 UI
  streamingContent += chunk;
});
```

### 意图分析算法

**关键词匹配：**
- 时间关键词：最新、今年、2024、2025、即将、上映
- 人物关键词：演员、导演、主演、作品
- 新闻关键词：新闻、消息、官宣、定档

**决策逻辑：**
```typescript
needWebSearch = hasTimeKeyword ||
                hasPersonKeyword ||
                hasNewsKeyword ||
                (hasRecommendKeyword && hasTimeKeyword);
```

### API Key 轮询

**轮询策略：**
```typescript
class ApiKeyRotator {
  - 维护可用 Key 列表
  - 跟踪失败的 Key
  - 从可用 Key 中轮询选择
  - 所有 Key 耗尽时自动重置
}
```

**故障转移流程：**
1. 尝试第一个 Key
2. 如果 401/429 错误 → 标记为失败
3. 尝试下一个可用 Key
4. 重复直到成功或所有 Key 耗尽

### 视频上下文结构

```typescript
interface VideoContext {
  title?: string;           // "流浪地球2"
  year?: string;            // "2023"
  douban_id?: number;       // 26266893
  tmdb_id?: number;         // 550988
  type?: 'movie' | 'tv';    // "movie"
  currentEpisode?: number;  // 5（电视剧）
}
```

**系统提示词增强：**
```
## 【当前视频上下文】
用户正在浏览: 流浪地球2 (2023)
```

---

## 常见问题

### Q: Tavily 可以免费获得多少次 API 调用？

**A:** 每个 Tavily 账号每月提供 **1000 次免费 API 调用**。你可以用不同的邮箱注册多个账号，并在 LunaTV 中配置所有 Key 以实现自动轮询。

**示例：**
- 1 个 Key = 每月 1,000 次调用
- 5 个 Key = 每月 5,000 次调用
- 10 个 Key = 每月 10,000 次调用

### Q: Tavily Key 用完额度后会怎样？

**A:** 系统会自动：
1. 检测到 429（速率限制）错误
2. 标记该 Key 为失败
3. 切换到下一个可用 Key
4. 无缝继续请求

### Q: AI 功能必须配置 Tavily 才能使用吗？

**A:** 不是。Tavily 是**可选的**，仅用于联网搜索功能。基础的 AI 推荐功能无需 Tavily 即可工作。但是，对于时效性问题（如"2025年最新电影"），联网搜索能提供更准确的结果。

### Q: 全局 AI 按钮和影片卡片 AI 按钮有什么区别？

**A:**

| 功能 | 全局 AI 按钮 | 影片卡片 AI 按钮 |
|------|-------------|-----------------|
| 上下文 | 无 | 影片信息 |
| 问题类型 | 通用 | 上下文感知 |
| 示例 | "推荐科幻电影" | "这部讲什么？" |
| 联网搜索 | 通用搜索 | 针对性搜索 |

### Q: 可以使用 Claude API 代替 OpenAI 吗？

**A:** 可以！任何 OpenAI 兼容的 API 都可以使用，包括：
- OpenAI GPT-3.5/GPT-4
- Claude（通过兼容代理）
- 本地模型（Ollama, LM Studio）
- 其他提供商（Groq, Together.ai 等）

只需相应配置 API URL 和密钥即可。

### Q: 为什么影片卡片上没有显示 AI 按钮？

**A:** 请检查：
1. ✅ 管理面板中 AI 功能已启用
2. ✅ 已配置有效的 API 密钥
3. ✅ 桌面端需鼠标悬停在卡片上（移动端需长按）
4. ✅ 影片有标题（上下文必需）

### Q: 智能定位是如何工作的？

**A:** AI 按钮会自动调整位置：
- **有底部标签**（已完结、已上映等） → 按钮上移（bottom-14）
- **无底部标签** → 按钮靠近底部（bottom-4）
- **防止重叠** 与现有 UI 元素

### Q: 可以禁用流式响应吗？

**A:** 目前流式响应默认启用以获得更好的用户体验。如需使用非流式模式，需要修改前端代码，不传递流式回调函数。

### Q: 我的数据如何存储？

**A:**
- 对话历史缓存在**浏览器 localStorage**，保留 30 分钟
- 服务器**不存储**聊天历史
- 仅最新请求缓存 5 分钟（仅限简单查询）
- 上下文数据（影片信息）随请求发送，不存储

### Q: 如何获得更多免费额度？

**A:**
**Tavily 策略（推荐）：**
1. 用多个邮箱注册 Tavily 账号
2. 每个账号获取 1 个 API Key（1000次/月）
3. 在管理面板配置所有 Key
4. 系统自动轮询使用

**示例：**
- 注册 5 个 Tavily 账号 = 5000 次/月免费
- 注册 10 个 Tavily 账号 = 10000 次/月免费

### Q: AI 回复中的电影名为什么可以点击？

**A:** 系统会自动识别 AI 回复中的《片名》格式，并将其：
1. 高亮显示为蓝色
2. 自动提取片名
3. 生成搜索链接

**支持的格式：**
- 《片名》 - 主要格式
- "片名" - 备用格式
- 【片名】 - 备用格式

点击后会跳转到搜索页面，显示该影片的可用播放源。

### Q: 为什么 AI 回复有时不使用 Markdown？

**A:** 可能的原因：
1. AI 模型选择不使用（温度设置影响）
2. 问题类型不适合 Markdown（简单问答）
3. 系统提示词未正确传递

建议在问题中明确要求："请用 Markdown 格式回复"

---

## 支持

如有问题或功能请求，请：
1. 查看此文档
2. 检查管理面板设置
3. 查看浏览器控制台错误
4. 联系管理员

---

## 附录：配置示例

### 完整配置示例

```json
{
  "AIRecommendConfig": {
    "enabled": true,
    "apiUrl": "https://api.openai.com/v1",
    "apiKey": "sk-xxxxxxxxxxxxxxxx",
    "model": "gpt-4",
    "temperature": 0.7,
    "maxTokens": 3000,
    "enableOrchestrator": true,
    "enableWebSearch": true,
    "tavilyApiKeys": [
      "tvly-key1xxxxxxxxxx",
      "tvly-key2xxxxxxxxxx",
      "tvly-key3xxxxxxxxxx"
    ]
  }
}
```

### 推荐配置方案

**方案一：基础配置（无联网搜索）**
- ✅ 启用 AI
- ✅ 配置 OpenAI API
- ❌ 不启用 Orchestrator
- 适合：基础推荐需求

**方案二：智能配置（有联网搜索）**
- ✅ 启用 AI
- ✅ 配置 OpenAI API
- ✅ 启用 Orchestrator
- ✅ 启用联网搜索
- ✅ 配置 3-5 个 Tavily Key
- 适合：需要最新资讯的用户

**方案三：高级配置（大量调用）**
- ✅ 启用 AI
- ✅ 使用高性能模型（GPT-4）
- ✅ 启用 Orchestrator
- ✅ 启用联网搜索
- ✅ 配置 10+ 个 Tavily Key
- 适合：高频使用场景

---

**最后更新：** 2025-12-29
**版本：** 5.9.0
**文档语言：** 简体中文
