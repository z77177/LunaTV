# è‡ªå®šä¹‰å»å¹¿å‘ŠåŠŸèƒ½ä½¿ç”¨æ–‡æ¡£

LunaTV æä¾›å¼ºå¤§çš„è‡ªå®šä¹‰å»å¹¿å‘ŠåŠŸèƒ½ï¼Œå…è®¸ç®¡ç†å‘˜ç¼–å†™ JavaScript ä»£ç å®ç°æ›´ç²¾å‡†çš„ M3U8 è§†é¢‘æµå¹¿å‘Šè¿‡æ»¤ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

âœ… **çµæ´»çš„è¿‡æ»¤é€»è¾‘**
- é’ˆå¯¹ä¸åŒæ’­æ”¾æºå®ç°ä¸åŒçš„è¿‡æ»¤ç­–ç•¥
- åŸºäºå…³é”®å­—çš„æ™ºèƒ½å¹¿å‘Šæ£€æµ‹
- æ”¯æŒå¤æ‚çš„å¹¿å‘Šæ£€æµ‹ç®—æ³•

âœ… **åŠ¨æ€é…ç½®**
- æ— éœ€ä¿®æ”¹æºä»£ç ï¼Œåœ¨çº¿ç¼–è¾‘å³å¯ç”Ÿæ•ˆ
- ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿æ›´æ–°åŠæ—¶æ¨é€
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶ï¼Œä¼˜åŒ–åŠ è½½æ€§èƒ½
- è‡ªåŠ¨é™çº§ç­–ç•¥ï¼Œå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤è§„åˆ™

âœ… **å¼€å‘å‹å¥½**
- å†…ç½®ç¤ºä¾‹ä»£ç ï¼Œå¿«é€Ÿä¸Šæ‰‹
- æ”¯æŒ TypeScript ç±»å‹æ³¨è§£ï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
- è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—è¾“å‡º

âœ… **å®‰å…¨å¯é **
- ä»…ç®¡ç†å‘˜å¯ç¼–è¾‘
- å®¢æˆ·ç«¯æ²™ç®±æ‰§è¡Œ
- é”™è¯¯è‡ªåŠ¨é™çº§ï¼Œä¸å½±å“æ’­æ”¾

---

## å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šè¿›å…¥ç®¡ç†é¢æ¿

è®¿é—® `/admin` é¡µé¢ï¼Œæ‰¾åˆ° **"è‡ªå®šä¹‰å»å¹¿å‘Š"** æ ‡ç­¾é¡µã€‚

### æ­¥éª¤ 2ï¼šç¼–å†™è‡ªå®šä¹‰ä»£ç 

ç‚¹å‡» **"è½½å…¥ç¤ºä¾‹ä»£ç "** æŒ‰é’®æŸ¥çœ‹ç¤ºä¾‹ï¼Œæˆ–ç›´æ¥ç¼–å†™è‡ªå·±çš„ä»£ç ã€‚

### æ­¥éª¤ 3ï¼šä¿å­˜é…ç½®

ç¼–å†™å®Œæˆåç‚¹å‡» **"ä¿å­˜é…ç½®"** æŒ‰é’®ã€‚

### æ­¥éª¤ 4ï¼šæµ‹è¯•æ•ˆæœ

åˆ·æ–°æ’­æ”¾é¡µé¢ï¼Œè‡ªå®šä¹‰å»å¹¿å‘Šä»£ç å°†è‡ªåŠ¨ç”Ÿæ•ˆã€‚æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰å¯ä»¥çœ‹åˆ° `âœ… ä½¿ç”¨è‡ªå®šä¹‰å»å¹¿å‘Šä»£ç ` çš„æ—¥å¿—ã€‚

---

## ä»£ç è§„èŒƒ

### å‡½æ•°ç­¾å

è‡ªå®šä¹‰ä»£ç å¿…é¡»å®šä¹‰ä¸€ä¸ªåä¸º `filterAdsFromM3U8` çš„å‡½æ•°ï¼š

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  // type: æ’­æ”¾æºçš„ key (ä¾‹å¦‚: 'ruyi', 'dyttzy', 'kuaikan' ç­‰)
  // m3u8Content: åŸå§‹çš„ m3u8 æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²

  // è¿”å›è¿‡æ»¤åçš„ m3u8 å†…å®¹å­—ç¬¦ä¸²
  return filteredContent;
}
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `type` | string | å½“å‰è§†é¢‘çš„æ’­æ”¾æº keyï¼Œå¯æ ¹æ®ä¸åŒæºå®ç°ä¸åŒé€»è¾‘ |
| `m3u8Content` | string | åŸå§‹çš„ m3u8 æ–‡ä»¶å†…å®¹ |

### è¿”å›å€¼

**å¿…é¡»è¿”å›**ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«è¿‡æ»¤åçš„ m3u8 å†…å®¹ã€‚

âš ï¸ **é‡è¦**ï¼šå¦‚æœè¿”å›ç©ºå­—ç¬¦ä¸²æˆ–éå­—ç¬¦ä¸²ç±»å‹ï¼Œå¯èƒ½å¯¼è‡´è§†é¢‘æ— æ³•æ’­æ”¾ã€‚

---

## ç¤ºä¾‹ä»£ç 

### ç¤ºä¾‹ 1ï¼šåŸºäºå…³é”®å­—çš„å¹¿å‘Šè¿‡æ»¤ï¼ˆæ¨èï¼‰

ä½¿ç”¨ URL å…³é”®å­—æ£€æµ‹å¹¿å‘Šç‰‡æ®µï¼Œé€‚åˆå¤§å¤šæ•°æ’­æ”¾æºçš„é€šç”¨è¿‡æ»¤é€»è¾‘ã€‚

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  if (!m3u8Content) return '';

  // å¹¿å‘Šå…³é”®å­—åˆ—è¡¨
  const adKeywords = [
    'sponsor',
    '/ad/',
    '/ads/',
    'advert',
    'advertisement',
    '/adjump',
    'redtraffic'
  ];

  // æŒ‰è¡Œåˆ†å‰²M3U8å†…å®¹
  const lines = m3u8Content.split('\n');
  const filteredLines = [];

  let i = 0;
  while (i < lines.length) {
    const line = lines[i];

    // è·³è¿‡ #EXT-X-DISCONTINUITY æ ‡è¯†
    if (line.includes('#EXT-X-DISCONTINUITY')) {
      i++;
      continue;
    }

    // å¦‚æœæ˜¯ EXTINF è¡Œï¼Œæ£€æŸ¥ä¸‹ä¸€è¡Œ URL æ˜¯å¦åŒ…å«å¹¿å‘Šå…³é”®å­—
    if (line.includes('#EXTINF:')) {
      // æ£€æŸ¥ä¸‹ä¸€è¡Œ URL æ˜¯å¦åŒ…å«å¹¿å‘Šå…³é”®å­—
      if (i + 1 < lines.length) {
        const nextLine = lines[i + 1];
        const containsAdKeyword = adKeywords.some(keyword =>
          nextLine.toLowerCase().includes(keyword.toLowerCase())
        );

        if (containsAdKeyword) {
          // è·³è¿‡ EXTINF è¡Œå’Œ URL è¡Œ
          i += 2;
          continue;
        }
      }
    }

    // ä¿ç•™å½“å‰è¡Œ
    filteredLines.push(line);
    i++;
  }

  return filteredLines.join('\n');
}
```

### ç¤ºä¾‹ 2ï¼šç»“åˆå…³é”®å­—å’Œè‡ªå®šä¹‰è§„åˆ™

æ ¹æ®ä¸åŒæ’­æ”¾æºä½¿ç”¨ä¸åŒçš„è¿‡æ»¤ç­–ç•¥ï¼Œç»“åˆå…³é”®å­—æ£€æµ‹å’Œè‡ªå®šä¹‰è§„åˆ™ã€‚

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  if (!m3u8Content) return '';

  // å¹¿å‘Šå…³é”®å­—åˆ—è¡¨
  const adKeywords = [
    'sponsor',
    '/ad/',
    '/ads/',
    'advert',
    'advertisement',
    '/adjump',
    'redtraffic'
  ];

  const lines = m3u8Content.split('\n');
  const filteredLines = [];

  let i = 0;
  while (i < lines.length) {
    const line = lines[i];

    // è·³è¿‡ #EXT-X-DISCONTINUITY æ ‡è¯†
    if (line.includes('#EXT-X-DISCONTINUITY')) {
      i++;
      continue;
    }

    // å¦‚æœæ˜¯ EXTINF è¡Œï¼Œæ£€æŸ¥ä¸‹ä¸€è¡Œ URL
    if (line.includes('#EXTINF:')) {
      if (i + 1 < lines.length) {
        const nextLine = lines[i + 1];

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¹¿å‘Šå…³é”®å­—
        const containsAdKeyword = adKeywords.some(keyword =>
          nextLine.toLowerCase().includes(keyword.toLowerCase())
        );

        if (containsAdKeyword) {
          // è·³è¿‡ EXTINF è¡Œå’Œ URL è¡Œ
          i += 2;
          continue;
        }

        // é’ˆå¯¹ç‰¹å®šæºçš„é¢å¤–è§„åˆ™
        if (type === 'ruyi') {
          // å¦‚æ„æºï¼šæ£€æŸ¥ç‰¹å®šçš„ URL æ¨¡å¼
          if (nextLine.includes('ad-server') || nextLine.includes('promo')) {
            i += 2;
            continue;
          }
        }
      }
    }

    // ä¿ç•™å½“å‰è¡Œ
    filteredLines.push(line);
    i++;
  }

  return filteredLines.join('\n');
}
```

### ç¤ºä¾‹ 3ï¼šç»“åˆ SCTE-35 å’Œå…³é”®å­—æ£€æµ‹

æ”¯æŒè¡Œä¸šæ ‡å‡†çš„ SCTE-35 å¹¿å‘Šæ ‡è®°æ£€æµ‹ï¼ŒåŒæ—¶ç»“åˆå…³é”®å­—æ£€æµ‹ï¼Œæä¾›æ›´å…¨é¢çš„å¹¿å‘Šè¿‡æ»¤ã€‚

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  if (!m3u8Content) return '';

  // å¹¿å‘Šå…³é”®å­—åˆ—è¡¨
  const adKeywords = [
    'sponsor',
    '/ad/',
    '/ads/',
    'advert',
    'advertisement',
    '/adjump',
    'redtraffic'
  ];

  const lines = m3u8Content.split('\n');
  const filteredLines = [];
  let inAdBlock = false;
  let adSegmentCount = 0;

  let i = 0;
  while (i < lines.length) {
    const line = lines[i];

    // æ£€æµ‹è¡Œä¸šæ ‡å‡†å¹¿å‘Šæ ‡è®°ï¼ˆSCTE-35ç³»åˆ—ï¼‰
    if (line.includes('#EXT-X-CUE-OUT') ||
        (line.includes('#EXT-X-DATERANGE') && line.includes('SCTE35')) ||
        line.includes('#EXT-X-SCTE35') ||
        line.includes('#EXT-OATCLS-SCTE35')) {
      inAdBlock = true;
      adSegmentCount++;
      i++;
      continue;
    }

    // æ£€æµ‹å¹¿å‘Šç»“æŸæ ‡è®°
    if (line.includes('#EXT-X-CUE-IN')) {
      inAdBlock = false;
      i++;
      continue;
    }

    // è·³è¿‡å¹¿å‘ŠåŒºå—å†…å®¹
    if (inAdBlock) {
      i++;
      continue;
    }

    // è·³è¿‡ #EXT-X-DISCONTINUITY æ ‡è¯†
    if (line.includes('#EXT-X-DISCONTINUITY')) {
      i++;
      continue;
    }

    // å¦‚æœæ˜¯ EXTINF è¡Œï¼Œæ£€æŸ¥ä¸‹ä¸€è¡Œ URL æ˜¯å¦åŒ…å«å¹¿å‘Šå…³é”®å­—
    if (line.includes('#EXTINF:')) {
      if (i + 1 < lines.length) {
        const nextLine = lines[i + 1];
        const containsAdKeyword = adKeywords.some(keyword =>
          nextLine.toLowerCase().includes(keyword.toLowerCase())
        );

        if (containsAdKeyword) {
          adSegmentCount++;
          i += 2;
          continue;
        }
      }
    }

    // ä¿ç•™å½“å‰è¡Œ
    filteredLines.push(line);
    i++;
  }

  // è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
  if (adSegmentCount > 0) {
    console.log(`[å»å¹¿å‘Š] ${type} æºç§»é™¤äº† ${adSegmentCount} ä¸ªå¹¿å‘Šç‰‡æ®µ`);
  }

  return filteredLines.join('\n');
}
```

---

## M3U8 æ–‡ä»¶ç»“æ„è¯´æ˜

### åŸºæœ¬æ ‡ç­¾

| æ ‡ç­¾ | è¯´æ˜ |
|------|------|
| `#EXTM3U` | M3U8 æ–‡ä»¶å¤´ï¼ˆå¿…éœ€ï¼‰ |
| `#EXT-X-VERSION:3` | åè®®ç‰ˆæœ¬å· |
| `#EXT-X-TARGETDURATION:10` | æ¯ä¸ªç‰‡æ®µçš„æœ€å¤§æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `#EXTINF:9.975,` | ç‰‡æ®µæ—¶é•¿ä¿¡æ¯ |
| `video-001.ts` | è§†é¢‘ç‰‡æ®µæ–‡ä»¶ URL |

### å¹¿å‘Šç›¸å…³æ ‡ç­¾

| æ ‡ç­¾ | è¯´æ˜ | é‡è¦æ€§ |
|------|------|--------|
| `#EXT-X-CUE-OUT` | å¹¿å‘Šå¼€å§‹æ ‡è®° | â­â­â­â­â­ |
| `#EXT-X-CUE-IN` | å¹¿å‘Šç»“æŸæ ‡è®° | â­â­â­â­â­ |
| `#EXT-X-DISCONTINUITY` | ä¸è¿ç»­æ ‡è®°ï¼ˆå¹¿å‘Šå‰åå¸¸å‡ºç°ï¼‰ | â­â­â­â­ |
| `#EXT-X-DATERANGE` | æ—¥æœŸèŒƒå›´æ ‡è®°ï¼ˆå¯èƒ½åŒ…å« SCTE35ï¼‰ | â­â­â­ |
| `#EXT-X-SCTE35` | SCTE-35 æ ‡å‡†å¹¿å‘Šæ ‡è®° | â­â­â­â­â­ |
| `#EXT-OATCLS-SCTE35` | å…¶ä»–å¹³å°å¹¿å‘Šæ ‡è®° | â­â­â­ |

### å¤šç ç‡æµæ ‡ç­¾

- `#EXT-X-STREAM-INF` - å¤šç ç‡æµä¿¡æ¯
- åé¢è·Ÿç€å­ m3u8 æ–‡ä»¶çš„ URL

---

## æœ€ä½³å®è·µ

### 1. é’ˆå¯¹ä¸åŒæºä½¿ç”¨ä¸åŒç­–ç•¥

ä¸åŒçš„æ’­æ”¾æºå¯èƒ½ä½¿ç”¨ä¸åŒçš„å¹¿å‘Šæ’å…¥æ–¹å¼ï¼Œå»ºè®®ä½¿ç”¨ switch è¯­å¥ç»„ç»‡ä»£ç ï¼š

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  // æ ¹æ®ä¸åŒæºä½¿ç”¨ä¸åŒé€»è¾‘
  switch (type) {
    case 'ruyi':
      return filterRuyiAds(m3u8Content);
    case 'dyttzy':
      return filterDyttzAds(m3u8Content);
    case 'kuaikan':
      return filterKuaikanAds(m3u8Content);
    default:
      return filterDefaultAds(m3u8Content);
  }
}

function filterRuyiAds(content) {
  // å¦‚æ„æºçš„ä¸“ç”¨è¿‡æ»¤é€»è¾‘
}

function filterDyttzAds(content) {
  // ç”µå½±å¤©å ‚æºçš„ä¸“ç”¨è¿‡æ»¤é€»è¾‘
}

function filterKuaikanAds(content) {
  // å¿«çœ‹æºçš„ä¸“ç”¨è¿‡æ»¤é€»è¾‘
}

function filterDefaultAds(content) {
  // é»˜è®¤è¿‡æ»¤é€»è¾‘ï¼ˆSCTE-35 æ ‡å‡†ï¼‰
}
```

### 2. æ·»åŠ è°ƒè¯•ä¿¡æ¯

åœ¨å¼€å‘é˜¶æ®µå»ºè®®ä¿ç•™ console.log è¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•ï¼š

```javascript
const originalLines = lines.length;
const filteredCount = originalLines - filteredLines.length;

console.log(`[å»å¹¿å‘Š] æº: ${type}`);
console.log(`[å»å¹¿å‘Š] åŸå§‹è¡Œæ•°: ${originalLines}`);
console.log(`[å»å¹¿å‘Š] è¿‡æ»¤è¡Œæ•°: ${filteredCount}`);
console.log(`[å»å¹¿å‘Š] å‰©ä½™è¡Œæ•°: ${filteredLines.length}`);
```

### 3. å®Œå–„çš„é”™è¯¯å¤„ç†

è‡ªå®šä¹‰ä»£ç åº”è¯¥å…·æœ‰å®¹é”™æ€§ï¼Œé˜²æ­¢ä¸€ä¸ªé”™è¯¯å¯¼è‡´æ‰€æœ‰è§†é¢‘æ— æ³•æ’­æ”¾ï¼š

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  try {
    if (!m3u8Content) return '';

    // è¿‡æ»¤é€»è¾‘
    const filtered = performFiltering(m3u8Content);

    // éªŒè¯ç»“æœ
    if (!filtered || typeof filtered !== 'string') {
      console.error('[è¿‡æ»¤å™¨] è¿”å›å€¼æ— æ•ˆï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
      return m3u8Content;
    }

    return filtered;
  } catch (error) {
    console.error('[è¿‡æ»¤å™¨é”™è¯¯]', error);
    // è¿”å›åŸå§‹å†…å®¹ä½œä¸ºé™çº§æ–¹æ¡ˆ
    return m3u8Content;
  }
}
```

### 4. æ€§èƒ½ä¼˜åŒ–æŠ€å·§

å¯¹äºå¤§å‹ m3u8 æ–‡ä»¶ï¼ˆå‡ åƒè¡Œï¼‰ï¼Œæ³¨æ„æ€§èƒ½ä¼˜åŒ–ï¼š

```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  if (!m3u8Content) return '';

  // âœ… ä½¿ç”¨æ•°ç»„è€Œä¸æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
  const filteredLines = [];

  // âœ… é¢„ç¼–è¯‘å¸¸ç”¨çš„æ£€æµ‹æ¨¡å¼
  const adMarkers = [
    '#EXT-X-CUE-OUT',
    '#EXT-X-CUE-IN',
    '#EXT-X-DISCONTINUITY',
    'SCTE35'
  ];

  // âœ… é¿å…é‡å¤çš„ split æ“ä½œ
  const lines = m3u8Content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // è¿‡æ»¤é€»è¾‘
    // ...
  }

  // âœ… ä¸€æ¬¡æ€§ joinï¼Œé¿å…å¤šæ¬¡å­—ç¬¦ä¸²è¿æ¥
  return filteredLines.join('\n');
}
```

---

## ç‰ˆæœ¬ç®¡ç†ä¸ç¼“å­˜æœºåˆ¶

### ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬å·ï¼Ÿ

æµè§ˆå™¨ä¼šç¼“å­˜è‡ªå®šä¹‰å»å¹¿å‘Šä»£ç ã€‚å½“ä½ ä¿®æ”¹ä»£ç åï¼Œé€’å¢ç‰ˆæœ¬å·å¯ä»¥**å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è·å–æœ€æ–°ä»£ç **ã€‚

### æ™ºèƒ½ç¼“å­˜æœºåˆ¶

LunaTV ä½¿ç”¨æ™ºèƒ½ç¼“å­˜æœºåˆ¶ä¼˜åŒ–æ€§èƒ½ï¼š

1. **ç‰ˆæœ¬å·æ³¨å…¥**ï¼šæœåŠ¡å™¨åœ¨é¡µé¢åŠ è½½æ—¶å°†ç‰ˆæœ¬å·æ³¨å…¥åˆ° `RUNTIME_CONFIG`
2. **æœ¬åœ°ç¼“å­˜**ï¼šä»£ç å’Œç‰ˆæœ¬å·å­˜å‚¨åœ¨ `localStorage` ä¸­
3. **è‡ªåŠ¨æ£€æµ‹æ›´æ–°**ï¼šæ¯æ¬¡åŠ è½½æ’­æ”¾é¡µé¢æ—¶ï¼Œè‡ªåŠ¨æ¯”å¯¹ç‰ˆæœ¬å·
4. **æŒ‰éœ€è·å–**ï¼šä»…åœ¨ç‰ˆæœ¬å·å˜åŒ–æ—¶æ‰é‡æ–°è·å–å®Œæ•´ä»£ç 

### å¦‚ä½•ä½¿ç”¨ç‰ˆæœ¬å·

1. ä¿®æ”¹ä»£ç åï¼Œå°†ç‰ˆæœ¬å·ä» `1` æ”¹ä¸º `2`
2. ç‚¹å‡»"ä¿å­˜é…ç½®"
3. ç”¨æˆ·åˆ·æ–°é¡µé¢åä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬å¹¶åŠ è½½

ğŸ’¡ **æç¤º**ï¼š
- æ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½åº”è¯¥é€’å¢ç‰ˆæœ¬å·ï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·è·å¾—æœ€æ–°ç‰ˆæœ¬
- ç‰ˆæœ¬å·ä¸º `0` æ—¶è¡¨ç¤ºæœªå¯ç”¨è‡ªå®šä¹‰å»å¹¿å‘Šï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç©ºç¼“å­˜
- æ§åˆ¶å°ä¼šæ˜¾ç¤º `å»å¹¿å‘Šä»£ç å·²æ›´æ–°åˆ°ç‰ˆæœ¬ X` çš„æç¤ºä¿¡æ¯

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä»£ç ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šä¿®æ”¹ä»£ç åï¼Œæ’­æ”¾å™¨ä»ä½¿ç”¨æ—§è§„åˆ™æˆ–é»˜è®¤è§„åˆ™

**æ’æŸ¥æ­¥éª¤**ï¼š
1. âœ… æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript é”™è¯¯
2. âœ… ç¡®è®¤å·²ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®
3. âœ… å°è¯•é€’å¢ç‰ˆæœ¬å·å¹¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+F5 å¼ºåˆ¶åˆ·æ–°ï¼‰
4. âœ… æ£€æŸ¥å‡½æ•°åæ˜¯å¦ä¸º `filterAdsFromM3U8`ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
5. âœ… æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼ˆå¦‚ç¼ºå°‘æ‹¬å·ã€åˆ†å·ï¼‰

### é—®é¢˜ 2ï¼šè§†é¢‘æ— æ³•æ’­æ”¾

**ç—‡çŠ¶**ï¼šåº”ç”¨è‡ªå®šä¹‰ä»£ç åï¼Œè§†é¢‘æ’­æ”¾å¤±è´¥æˆ–é»‘å±

**æ’æŸ¥æ­¥éª¤**ï¼š
1. âœ… æ£€æŸ¥æ˜¯å¦è¿”å›äº†å­—ç¬¦ä¸²ç±»å‹ï¼ˆä¸èƒ½æ˜¯ null æˆ– undefinedï¼‰
2. âœ… æ£€æŸ¥è¿‡æ»¤åçš„ m3u8 æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå¿…é¡»æœ‰ #EXTM3U å¤´ï¼‰
3. âœ… æ·»åŠ  try-catch é”™è¯¯å¤„ç†
4. âœ… æ£€æŸ¥æ˜¯å¦è¯¯åˆ äº†é‡è¦çš„ m3u8 æ ‡ç­¾ï¼ˆå¦‚ #EXTINFï¼‰
5. âœ… æš‚æ—¶è¿”å›åŸå§‹å†…å®¹ `return m3u8Content;` æµ‹è¯•

### é—®é¢˜ 3ï¼šå¹¿å‘Šä»ç„¶å‡ºç°

**ç—‡çŠ¶**ï¼šåº”ç”¨è‡ªå®šä¹‰ä»£ç åï¼Œå¹¿å‘Šä¾ç„¶æ’­æ”¾

**æ’æŸ¥æ­¥éª¤**ï¼š
1. âœ… ä¸åŒæ’­æ”¾æºä½¿ç”¨ä¸åŒçš„å¹¿å‘Šæ ‡è®°ï¼Œéœ€è¦é’ˆå¯¹æ€§åˆ†æ
2. âœ… ä½¿ç”¨ `console.log(m3u8Content)` æ‰“å°åŸå§‹å†…å®¹
3. âœ… åˆ†æå¹¿å‘Šç‰‡æ®µçš„ç‰¹å¾ï¼ˆæ—¶é•¿ã€æ ‡è®°ã€URL æ¨¡å¼ï¼‰
4. âœ… æ ¹æ®åˆ†æç»“æœè°ƒæ•´è¿‡æ»¤è§„åˆ™
5. âœ… æµ‹è¯•å¤šä¸ªè§†é¢‘ï¼Œç¡®ä¿è§„åˆ™é€šç”¨æ€§

**ç¤ºä¾‹è°ƒè¯•ä»£ç **ï¼š
```javascript
function filterAdsFromM3U8(type, m3u8Content) {
  // æ‰“å°åŸå§‹å†…å®¹åˆ†æ
  console.log('=== M3U8 åŸå§‹å†…å®¹ ===');
  console.log(m3u8Content);

  // åˆ†æå¹¿å‘Šæ ‡è®°
  const hasAdMarkers = m3u8Content.includes('#EXT-X-CUE-OUT');
  console.log('åŒ…å«å¹¿å‘Šæ ‡è®°:', hasAdMarkers);

  // ç»§ç»­è¿‡æ»¤...
}
```

### é—®é¢˜ 4ï¼šæ‰§è¡Œå¤±è´¥è‡ªåŠ¨é™çº§

**ç—‡çŠ¶**ï¼šæ§åˆ¶å°æ˜¾ç¤º"æ‰§è¡Œè‡ªå®šä¹‰å»å¹¿å‘Šä»£ç å¤±è´¥ï¼Œé™çº§ä½¿ç”¨é»˜è®¤è§„åˆ™"

**è¯´æ˜**ï¼šè¿™æ˜¯æ­£å¸¸çš„é™çº§æœºåˆ¶ï¼Œä¸ä¼šå½±å“è§†é¢‘æ’­æ”¾

**æ’æŸ¥æ­¥éª¤**ï¼š
1. âœ… æŸ¥çœ‹æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. âœ… æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
3. âœ… æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æµè§ˆå™¨ä¸æ”¯æŒçš„ API
4. âœ… æ·»åŠ  try-catch é”™è¯¯å¤„ç†
5. âœ… ä¿®å¤é”™è¯¯åé€’å¢ç‰ˆæœ¬å·

---

## æŠ€æœ¯ç»†èŠ‚

### ä»£ç æ‰§è¡Œæµç¨‹

```
1. ç”¨æˆ·è®¿é—®æ’­æ”¾é¡µé¢
   â†“
2. ä» RUNTIME_CONFIG è¯»å–ç‰ˆæœ¬å·
   â†“
3. æ£€æŸ¥ localStorage ç¼“å­˜
   â”œâ”€ æœ‰ç¼“å­˜ä¸”ç‰ˆæœ¬å·ä¸€è‡´ â†’ ä½¿ç”¨ç¼“å­˜ä»£ç 
   â””â”€ æ— ç¼“å­˜æˆ–ç‰ˆæœ¬å·ä¸ä¸€è‡´ â†’ è°ƒç”¨ /api/ad-filter?full=true è·å–å®Œæ•´ä»£ç 
   â†“
4. å°†ä»£ç å’Œç‰ˆæœ¬å·å­˜å‚¨åˆ° localStorage
   â†“
5. æ’­æ”¾å™¨åŠ è½½ m3u8 æ–‡ä»¶
   â†“
6. è°ƒç”¨ filterAdsFromM3U8(type, content)
   â†“
7. ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ä»£ç ï¼Œå¤±è´¥åˆ™é™çº§åˆ°é»˜è®¤è§„åˆ™
   â†“
8. è¿”å›è¿‡æ»¤åçš„ m3u8 å†…å®¹ç»™æ’­æ”¾å™¨
```

### API ç«¯ç‚¹è¯´æ˜

**GET /api/ad-filter**

æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

1. **ç‰ˆæœ¬æ£€æŸ¥æ¨¡å¼**ï¼ˆä¸å¸¦å‚æ•°ï¼‰
   - è¯·æ±‚ï¼š`GET /api/ad-filter`
   - å“åº”ï¼š`{ "version": 1 }`
   - ç”¨é€”ï¼šå¿«é€Ÿæ£€æŸ¥ç‰ˆæœ¬å·ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°

2. **å®Œæ•´è·å–æ¨¡å¼**ï¼ˆå¸¦ `?full=true` å‚æ•°ï¼‰
   - è¯·æ±‚ï¼š`GET /api/ad-filter?full=true`
   - å“åº”ï¼š`{ "code": "...", "version": 1 }`
   - ç”¨é€”ï¼šè·å–å®Œæ•´çš„å»å¹¿å‘Šä»£ç å’Œç‰ˆæœ¬å·

ğŸ’¡ **ä¼˜åŒ–è¯´æ˜**ï¼š
- API ç«¯ç‚¹è®¾ç½®äº† `dynamic = 'force-dynamic'`ï¼Œç¦ç”¨ç¼“å­˜ç¡®ä¿å®æ—¶æ€§
- å®¢æˆ·ç«¯ä¼˜å…ˆä½¿ç”¨ localStorage ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- ä»…åœ¨ç‰ˆæœ¬å·å˜åŒ–æ—¶æ‰è¯·æ±‚å®Œæ•´ä»£ç ï¼Œä¼˜åŒ–æ€§èƒ½

### TypeScript ç±»å‹æ³¨è§£å¤„ç†

ç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤ TypeScript ç±»å‹æ³¨è§£ï¼Œå› æ­¤ä»¥ä¸‹ä»£ç éƒ½æ˜¯æœ‰æ•ˆçš„ï¼š

```javascript
// âœ… çº¯ JavaScriptï¼ˆæ¨èï¼Œå…¼å®¹æ€§æœ€å¥½ï¼‰
function filterAdsFromM3U8(type, m3u8Content) {
  // ...
}

// âœ… TypeScriptï¼ˆä¼šè‡ªåŠ¨è½¬æ¢ä¸º JavaScriptï¼‰
function filterAdsFromM3U8(type: string, m3u8Content: string): string {
  // ...
}
```

### å®‰å…¨æ€§è¯´æ˜

- âœ… è‡ªå®šä¹‰ä»£ç åœ¨**æµè§ˆå™¨å®¢æˆ·ç«¯**æ‰§è¡Œï¼Œä¸åœ¨æœåŠ¡å™¨ç«¯
- âœ… åªæœ‰**ç®¡ç†å‘˜**å¯ä»¥ç¼–è¾‘è‡ªå®šä¹‰ä»£ç 
- âœ… ä»£ç é€šè¿‡ `new Function()` æ‰§è¡Œï¼Œå…·æœ‰**æ²™ç®±éš”ç¦»**
- âœ… ä»£ç ä¸èƒ½è®¿é—®æ•æ„Ÿæ•°æ®ï¼ˆå¦‚ Cookieã€LocalStorage ä¹‹å¤–çš„æ•°æ®ï¼‰
- âš ï¸ è¯·å‹¿åœ¨ä»£ç ä¸­åŒ…å«æ¶æ„è„šæœ¬æˆ–è¯•å›¾è®¿é—®ç”¨æˆ·éšç§

---

## å¸¸è§é—®é¢˜ FAQ

### Q1: å¯ä»¥ä½¿ç”¨ ES6+ ç‰¹æ€§å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†è¦ç¡®ä¿ç›®æ ‡æµè§ˆå™¨æ”¯æŒã€‚å»ºè®®ä½¿ç”¨ ES5 è¯­æ³•ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§ã€‚

**æ¨èçš„ ES6 ç‰¹æ€§**ï¼š
- âœ… `const` / `let`ï¼ˆå¤§éƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
- âœ… ç®­å¤´å‡½æ•° `() => {}`ï¼ˆç°ä»£æµè§ˆå™¨æ”¯æŒï¼‰
- âœ… æ¨¡æ¿å­—ç¬¦ä¸² `` `${var}` ``ï¼ˆç°ä»£æµè§ˆå™¨æ”¯æŒï¼‰

**é¿å…ä½¿ç”¨**ï¼š
- âŒ `async/await`ï¼ˆå¯èƒ½ä¸æ”¯æŒï¼‰
- âŒ å¯é€‰é“¾ `?.`ï¼ˆè¾ƒæ–°ç‰¹æ€§ï¼‰
- âŒ ç©ºå€¼åˆå¹¶ `??`ï¼ˆè¾ƒæ–°ç‰¹æ€§ï¼‰

### Q2: å¯ä»¥å¼•å…¥å¤–éƒ¨åº“å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚è‡ªå®šä¹‰ä»£ç åªèƒ½ä½¿ç”¨**åŸç”Ÿ JavaScript API**ã€‚

### Q3: å¦‚ä½•è·å–å½“å‰è§†é¢‘çš„è¯¦ç»†ä¿¡æ¯ï¼Ÿ

**A**: `type` å‚æ•°åŒ…å«äº†æ’­æ”¾æºçš„ keyã€‚å¦‚éœ€æ›´å¤šä¿¡æ¯ï¼ˆå¦‚è§†é¢‘ IDã€æ ‡é¢˜ç­‰ï¼‰ï¼Œéœ€è¦åœ¨æºä»£ç ä¸­æ·»åŠ é¢å¤–çš„å‚æ•°ä¼ é€’é€»è¾‘ã€‚

### Q4: ä¿®æ”¹ä»£ç åéœ€è¦é‡å¯æœåŠ¡å™¨å—ï¼Ÿ

**A**: **ä¸éœ€è¦**ã€‚ä¿å­˜é…ç½®åï¼Œç”¨æˆ·åˆ·æ–°é¡µé¢å³å¯ç”Ÿæ•ˆã€‚è¿™æ˜¯åœ¨çº¿çƒ­æ›´æ–°æœºåˆ¶ã€‚

### Q5: å¯ä»¥å®Œå…¨ç¦ç”¨å»å¹¿å‘Šå—ï¼Ÿ

**A**:
- **ç”¨æˆ·ç«¯**ï¼šå¯ä»¥åœ¨æ’­æ”¾å™¨è®¾ç½®ä¸­å…³é—­å»å¹¿å‘ŠåŠŸèƒ½
- **ç®¡ç†ç«¯**ï¼šå¯ä»¥å°†è‡ªå®šä¹‰ä»£ç ç•™ç©ºï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤è§„åˆ™ï¼›æˆ–è€…åœ¨é»˜è®¤è§„åˆ™ä¸­ä¹Ÿå¯ä»¥é€‰æ‹©ç¦ç”¨

### Q6: ä»£ç æ‰§è¡Œå¤±è´¥ä¼šæ€æ ·ï¼Ÿ

**A**: ç³»ç»Ÿä¼š**è‡ªåŠ¨é™çº§**ä½¿ç”¨é»˜è®¤å»å¹¿å‘Šè§„åˆ™ï¼Œå¹¶åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚ä¸ä¼šå¯¼è‡´è§†é¢‘æ— æ³•æ’­æ”¾ã€‚

### Q7: ç‰ˆæœ¬å·æœ‰ä¸Šé™å—ï¼Ÿ

**A**: æ²¡æœ‰ã€‚ç‰ˆæœ¬å·å¯ä»¥æ˜¯ä»»æ„æ­£æ•´æ•°ï¼Œå»ºè®®æ¯æ¬¡ä¿®æ”¹é€’å¢ 1ã€‚

### Q8: å¯ä»¥é’ˆå¯¹ç‰¹å®šè§†é¢‘ ID è¿›è¡Œè¿‡æ»¤å—ï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬åªæä¾› `type`ï¼ˆæ’­æ”¾æºï¼‰å‚æ•°ã€‚å¦‚éœ€æŒ‰è§†é¢‘ ID è¿‡æ»¤ï¼Œéœ€è¦ä¿®æ”¹æºä»£ç æ·»åŠ è¯¥å‚æ•°ã€‚

---

## è´¡çŒ®ä¸åˆ†äº«

å¦‚æœä½ æœ‰å¥½çš„å»å¹¿å‘Šè§„åˆ™ï¼Œæ¬¢è¿åˆ†äº«åˆ°ç¤¾åŒºï¼

### åˆ†äº«æ ¼å¼

```markdown
## [æºåç§°] å»å¹¿å‘Šè§„åˆ™

**é€‚ç”¨æº**: source-key
**è¯´æ˜**: ç®€çŸ­æè¿°è¿™ä¸ªè§„åˆ™çš„ä½œç”¨
**ä½œè€…**: ä½ çš„åå­—ï¼ˆå¯é€‰ï¼‰

\`\`\`javascript
function filterAdsFromM3U8(type, m3u8Content) {
  // ä½ çš„ä»£ç 
}
\`\`\`

**æµ‹è¯•æƒ…å†µ**:
- âœ… æˆåŠŸç§»é™¤ç‰‡å¤´å¹¿å‘Š
- âœ… æˆåŠŸç§»é™¤ä¸­é—´æ’æ’­å¹¿å‘Š
- âœ… æˆåŠŸç§»é™¤ç‰‡å°¾å¹¿å‘Š
- âš ï¸ æŸäº›ç‰¹å®šå¹¿å‘Šæš‚æ—¶æ— æ³•è¯†åˆ«
```

### ç¤ºä¾‹åˆ†äº«

```markdown
## å¦‚æ„æºï¼ˆruyiï¼‰å»å¹¿å‘Šè§„åˆ™

**é€‚ç”¨æº**: ruyi
**è¯´æ˜**: ç§»é™¤å¦‚æ„æºä¸­ç‰¹å®šæ—¶é•¿çš„å¹¿å‘Šç‰‡æ®µ
**ä½œè€…**: LunaTV ç¤¾åŒº

\`\`\`javascript
function filterAdsFromM3U8(type, m3u8Content) {
  if (type !== 'ruyi' || !m3u8Content) return m3u8Content;

  const lines = m3u8Content.split('\n');
  const filteredLines = [];
  let skipNext = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (skipNext) {
      skipNext = false;
      continue;
    }

    // è¿‡æ»¤ 5.64ç§’ã€2.96ç§’ã€3.48ç§’ çš„å¹¿å‘Šç‰‡æ®µ
    if (line.includes('EXTINF:5.640000') ||
        line.includes('EXTINF:2.960000') ||
        line.includes('EXTINF:3.480000')) {
      skipNext = true;
      continue;
    }

    filteredLines.push(line);
  }

  return filteredLines.join('\n');
}
\`\`\`

**æµ‹è¯•æƒ…å†µ**:
- âœ… æˆåŠŸç§»é™¤ç‰‡å¤´ 5.64 ç§’å¹¿å‘Š
- âœ… æˆåŠŸç§»é™¤ä¸­é—´ 2.96 ç§’æ’æ’­å¹¿å‘Š
- âœ… æˆåŠŸç§»é™¤ç‰‡å°¾ 3.48 ç§’å¹¿å‘Š
```

---

## ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [M3U8 æ ¼å¼è§„èŒƒ (RFC 8216)](https://datatracker.ietf.org/doc/html/rfc8216) - M3U8/HLS åè®®å®˜æ–¹æ ‡å‡†
- [SCTE-35 å¹¿å‘Šæ ‡å‡†](https://www.scte.org/standards/library/catalog/scte-35-digital-program-insertion-cueing-message/) - è¡Œä¸šæ ‡å‡†å¹¿å‘Šæ’å…¥è§„èŒƒ
- [HLS åè®®æ–‡æ¡£](https://developer.apple.com/streaming/) - Apple å®˜æ–¹ HLS æµåª’ä½“åè®®æ–‡æ¡£

### ç¤¾åŒºèµ„æº

- LunaTV Issues - æäº¤ Bug æˆ–åŠŸèƒ½å»ºè®®
- LunaTV Discussions - è®¨è®ºå»å¹¿å‘Šè§„åˆ™å’Œæœ€ä½³å®è·µ

### å·¥å…·æ¨è

- **åœ¨çº¿ M3U8 è§£æå™¨** - åˆ†æ m3u8 æ–‡ä»¶ç»“æ„
- **æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)** - æŸ¥çœ‹ç½‘ç»œè¯·æ±‚å’Œè°ƒè¯•ä»£ç 
- **VSCode** - ç¼–å†™å’Œæµ‹è¯• JavaScript ä»£ç 

---

## æ›´æ–°æ—¥å¿—

### ç‰ˆæœ¬å†å²

- **v1.0** - åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„è‡ªå®šä¹‰å»å¹¿å‘ŠåŠŸèƒ½
- **v1.1** - æ·»åŠ ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼Œæ”¯æŒä»£ç çƒ­æ›´æ–°
- **v1.2** - æ·»åŠ  TypeScript ç±»å‹æ³¨è§£è‡ªåŠ¨ç§»é™¤
- **v1.3** - ä¼˜åŒ–é”™è¯¯å¤„ç†ï¼Œæ·»åŠ è‡ªåŠ¨é™çº§æœºåˆ¶
- **v1.4** (2026-01-26) - é‡å¤§æ›´æ–°ï¼š
  - âœ¨ æ–°å¢åŸºäºå…³é”®å­—çš„å¹¿å‘Šæ£€æµ‹ï¼ˆsponsor, /ad/, /ads/, advert, advertisement, /adjump, redtrafficï¼‰
  - âš¡ ä¼˜åŒ– API ç«¯ç‚¹ï¼šæ”¯æŒç‰ˆæœ¬æ£€æŸ¥æ¨¡å¼å’Œå®Œæ•´è·å–æ¨¡å¼
  - ğŸš€ å®ç°æ™ºèƒ½ç¼“å­˜æœºåˆ¶ï¼šä½¿ç”¨ localStorage ç¼“å­˜ä»£ç ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
  - ğŸ“¦ ç‰ˆæœ¬å·æ³¨å…¥åˆ° RUNTIME_CONFIGï¼Œå®ç°å®¢æˆ·ç«¯å¿«é€Ÿç‰ˆæœ¬æ£€æŸ¥
  - ğŸ”§ æ”¹è¿› M3U8 å¤„ç†é€»è¾‘ï¼šæ­£ç¡®è·³è¿‡ #EXT-X-DISCONTINUITY æ ‡è¯†
  - ğŸ¯ é»˜è®¤å»å¹¿å‘Šè§„åˆ™ä»åŸºäºæ—¶é•¿æ£€æµ‹å‡çº§ä¸ºåŸºäº URL å…³é”®å­—æ£€æµ‹

---

## è®¸å¯è¯ä¸å…è´£å£°æ˜

- LunaTV è‡ªå®šä¹‰å»å¹¿å‘ŠåŠŸèƒ½éµå¾ª LunaTV é¡¹ç›®è®¸å¯è¯
- å»å¹¿å‘ŠåŠŸèƒ½ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
- è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„å’Œç‰ˆæƒè§„å®š
- ä½¿ç”¨è‡ªå®šä¹‰ä»£ç äº§ç”Ÿçš„ä»»ä½•åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…

---

## æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿæˆ‘ä»¬éšæ—¶ä¸ºä½ æä¾›å¸®åŠ©ï¼

- **åŠŸèƒ½é—®é¢˜** - åœ¨ LunaTV é¡¹ç›®ä»“åº“æäº¤ Issue
- **è§„åˆ™åˆ†äº«** - åœ¨ Discussions åŒºåŸŸå‘å¸ƒä½ çš„å»å¹¿å‘Šè§„åˆ™
- **Bug æŠ¥å‘Š** - æä¾›è¯¦ç»†çš„å¤ç°æ­¥éª¤å’Œé”™è¯¯æ—¥å¿—

---

**è®©è§‚å½±ä½“éªŒæ›´çº¯ç²¹ï¼Œäº«å—æ— å¹¿å‘Šçš„æµç•…æ’­æ”¾ï¼** ğŸ¬âœ¨
